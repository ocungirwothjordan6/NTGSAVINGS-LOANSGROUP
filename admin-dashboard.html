<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
body{font-family:'Segoe UI',sans-serif; background:#f5fff5; padding:1rem;}
h2{text-align:center; color:#046307;}
.container{max-width:1000px;margin:auto;}
table{width:100%;border-collapse:collapse;margin-bottom:2rem;}
th,td{border:1px solid #ccc;padding:0.5rem;text-align:center;}
th{background:#046307;color:white;}
button{padding:0.3rem 0.6rem;background:#046307;color:white;border:none;border-radius:5px;cursor:pointer;}
button:hover{background:#034b02;}
</style>
</head>
<body>
<h2>Admin Dashboard</h2>
<div class="container">
  <h3>Member Loan Requests</h3>
  <table id="requestTable">
    <tr>
      <th>Member</th><th>Amount</th><th>Status</th><th>Requested On</th><th>Repayment Date</th><th>Actions</th>
    </tr>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAZO0T9eGAwyd8nZ-A4p9AjaMiCuYamhM4",
  authDomain: "ntgsavings-loansgroup.firebaseapp.com",
  projectId: "ntgsavings-loansgroup",
  storageBucket: "ntgsavings-loansgroup.appspot.com",
  messagingSenderId: "836958799412",
  appId: "1:836958799412:web:26540535294f3c9d2f2c61",
  measurementId: "G-QMPM1RL98B"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const loggedInUser = localStorage.getItem("loggedInUser");
if(!loggedInUser || loggedInUser!=="Admin"){ window.location.href="login.html"; }

const membersRef = ref(db, "members");

function renderRequests(members){
  const table = document.getElementById("requestTable");
  table.innerHTML=`<tr>
    <th>Member</th><th>Amount</th><th>Status</th><th>Requested On</th><th>Repayment Date</th><th>Actions</th>
  </tr>`;
  for(const username in members){
    const mem = members[username];
    mem.loanRequests.forEach((loan,index)=>{
      const row = table.insertRow();
      row.insertCell(0).textContent = username;
      row.insertCell(1).textContent = loan.amount;
      row.insertCell(2).textContent = loan.status;
      row.insertCell(3).textContent = loan.requestDate;
      row.insertCell(4).textContent = loan.repaymentDate||"-";
      const actionsCell = row.insertCell(5);
      if(loan.status==="pending"){
        const approveBtn = document.createElement("button");
        approveBtn.textContent="Approve";
        approveBtn.onclick = ()=>approveLoan(username,index);
        const rejectBtn = document.createElement("button");
        rejectBtn.textContent="Reject";
        rejectBtn.onclick = ()=>rejectLoan(username,index);
        actionsCell.appendChild(approveBtn);
        actionsCell.appendChild(rejectBtn);
      } else {
        actionsCell.textContent="-";
      }
    });
  }
}

function approveLoan(username,index){
  const today = new Date();
  const repayment = new Date(today.setDate(today.getDate()+30)).toISOString().split("T")[0];
  const loanRef = ref(db, `members/${username}/loanRequests/${index}`);
  update(loanRef, { status:"Approved", repaymentDate: repayment });
}

function rejectLoan(username,index){
  const loanRef = ref(db, `members/${username}/loanRequests/${index}`);
  update(loanRef, { status:"Rejected" });
}

// Real-time listener for all members
onValue(membersRef, (snapshot)=>{
  const members = snapshot.val();
  renderRequests(members);
});
</script>
</body>
</html>

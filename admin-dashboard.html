<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
body{font-family:'Segoe UI',sans-serif; background:#f5fff5; padding:1rem;}
h2{text-align:center; color:#046307;}
.container{max-width:1000px;margin:auto;}
table{width:100%;border-collapse:collapse;margin-bottom:2rem;}
th,td{border:1px solid #ccc;padding:0.5rem;text-align:center;}
th{background:#046307;color:white;}
button{padding:0.3rem 0.6rem;background:#046307;color:white;border:none;border-radius:5px;cursor:pointer;}
button:hover{background:#034b02;}
</style>
</head>
<body>

<h2>Admin Dashboard</h2>
<div class="container">
  <h3>Member Loan Requests</h3>
  <table id="requestTable">
    <tr>
      <th>Member</th><th>Amount</th><th>Status</th><th>Requested On</th><th>Repayment Date</th><th>Actions</th>
    </tr>
  </table>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyAZO0T9eGAwyd8nZ-A4p9AjaMiCuYamhM4",
  authDomain: "ntgsavings-loansgroup.firebaseapp.com",
  projectId: "ntgsavings-loansgroup",
  storageBucket: "ntgsavings-loansgroup.appspot.com",
  messagingSenderId: "836958799412",
  appId: "1:836958799412:web:26540535294f3c9d2f2c61",
  measurementId: "G-QMPM1RL98B"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Admin Auth Check ---
const adminUser = localStorage.getItem("loggedInUser");
if(!adminUser || localStorage.getItem("role")!=="admin") window.location.href="index.html";

// Reference to members collection
const membersCol = collection(db, "members");

// --- Render Loan Requests in Real-Time ---
function renderRequests(membersData){
  let html="";
  for(const name in membersData){
    const mem = membersData[name];
    mem.loanRequests?.forEach((l,i)=>{
      html+=`<tr>
        <td>${name}</td>
        <td>${l.amount}</td>
        <td>${l.status}</td>
        <td>${l.dateRequested}</td>
        <td>${l.repaymentDate||"-"}</td>
        <td>
          ${l.status==="pending"?`<button onclick="approveLoan('${name}','${i}')">Approve</button>
          <button onclick="rejectLoan('${name}','${i}')">Reject</button>`:"-"}
        </td>
      </tr>`;
    });
  }
  document.getElementById("requestTable").innerHTML=`<tr>
    <th>Member</th><th>Amount</th><th>Status</th><th>Requested On</th><th>Repayment Date</th><th>Actions</th>
  </tr>`+html;
}

// --- Listen to Live Updates ---
onSnapshot(membersCol, snapshot => {
  let membersData = {};
  snapshot.forEach(docSnap => {
    membersData[docSnap.id] = docSnap.data();
  });
  renderRequests(membersData);
});

// --- Approve/Reject Functions ---
window.approveLoan = async function(memberName,index){
  const docRef = doc(db, "members", memberName);
  const docSnap = await docRef.get();
  const mem = (await docRef.get()).data();

  const today = new Date();
  mem.loanRequests[index].status = "approved";
  mem.loanRequests[index].repaymentDate = new Date(today.setDate(today.getDate()+30)).toLocaleDateString();
  mem.numberOfLoans = (mem.numberOfLoans || 0) + 1;

  await setDoc(docRef, mem);
  alert("Loan approved and repayment date set!");
}

window.rejectLoan = async function(memberName,index){
  const docRef = doc(db, "members", memberName);
  const mem = (await docRef.get()).data();
  mem.loanRequests[index].status = "rejected";
  await setDoc(docRef, mem);
  alert("Loan rejected!");
}
</script>

</body>
</html>

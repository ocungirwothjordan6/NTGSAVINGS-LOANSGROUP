<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NTG Admin Dashboard</title>
<style>
body{font-family:'Segoe UI',sans-serif; margin:0; background:#f7f9fc;}
header{padding:1rem 2rem;background:#046307;color:white;display:flex;justify-content:space-between;align-items:center;}
header h1{margin:0;}
header button{padding:0.5rem 1rem;border:none;border-radius:5px;background:#e53e3e;color:white;cursor:pointer;}
header button:hover{background:#c53030;}
.container{max-width:1200px;margin:2rem auto;background:white;padding:2rem;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ccc;padding:0.5rem;text-align:center;}
th{background:#046307;color:white;}
button.actionBtn{margin:0 2px;padding:0.3rem 0.6rem;border:none;border-radius:5px;background:#046307;color:white;cursor:pointer;}
button.actionBtn:hover{background:#034b02;}
</style>
</head>
<body>

<header>
  <h1>NTG Admin Dashboard</h1>
  <button onclick="logout()">Logout</button>
</header>

<div class="container">
  <h2>Member Loan Requests</h2>
  <table id="requestTable">
    <thead>
      <tr><th>Member</th><th>Amount</th><th>Status</th><th>Requested</th><th>Repayment</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAZO0T9eGAwyd8nZ-A4p9AjaMiCuYamhM4",
  authDomain: "ntgsavings-loansgroup.firebaseapp.com",
  databaseURL: "https://ntgsavings-loansgroup-default-rtdb.firebaseio.com",
  projectId: "ntgsavings-loansgroup",
  storageBucket: "ntgsavings-loansgroup.appspot.com",
  messagingSenderId: "836958799412",
  appId: "1:836958799412:web:26540535294f3c9d2f2c61"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const loggedInUser = localStorage.getItem("loggedInUser");
if(!loggedInUser || localStorage.getItem("isAdmin")!=="true") window.location.href="login.html";

const requestTableBody = document.querySelector("#requestTable tbody");

// Live update all loan requests
const membersRef = ref(db, "members");
onValue(membersRef, snap=>{
  const members = snap.val()||{};
  renderRequests(members);
});

function renderRequests(members) {
  requestTableBody.innerHTML="";
  Object.entries(members).forEach(([name, mem])=>{
    (mem.loanRequests||[]).forEach((loan,i)=>{
      const row = document.createElement("tr");
      row.innerHTML = `<td>${name}</td>
        <td>${loan.amount}</td>
        <td>${loan.status}</td>
        <td>${loan.dateRequested}</td>
        <td>${loan.repaymentDate||"-"}</td>
        <td>
          ${loan.status==="pending" ? `<button class="actionBtn" onclick="approveLoan('${name}',${i})">Approve</button>
          <button class="actionBtn" onclick="rejectLoan('${name}',${i})">Reject</button>` : "-"}
        </td>`;
      requestTableBody.appendChild(row);
    });
  });
}

// Approve/reject actions
function approveLoan(name,index){
  const today = new Date();
  const repayment = new Date(today);
  repayment.setDate(repayment.getDate()+30);
  update(ref(db, `members/${name}/loanRequests/${index}`), {status:"approved", repaymentDate: repayment.toLocaleDateString()});
}

function rejectLoan(name,index){
  update(ref(db, `members/${name}/loanRequests/${index}`), {status:"rejected"});
}

// Logout
function logout() { localStorage.removeItem("loggedInUser"); localStorage.removeItem("isAdmin"); window.location.href="login.html"; }
</script>

</body>
</html>
